{% from "components/estrellas.html" import render_estrellas %}
{% extends "base.html" %}

{% block page_header %}
    {% set titulo = "Servicios disponibles" %}
    {% set subtitulo = "Mira los servicios disponibles en MisServicios" %}
    {% include "components/page_header.html" %}
{% endblock %}

{% block content %}

<div class="container mt-4">
    <!-- BUSCADOR DE SERVICIOS -->
    <form onsubmit="return false;" class="mb-4">
        <div class="input-group">

            <input
                type="text"
                id="buscador"
                name="q"
                class="form-control"
                placeholder="Buscar por nombre o categoría..."
                value="{{ query }}"
                autocomplete="off"
            >

            <button class="btn btn-primary">
                Buscar
            </button>

        </div>
    </form>


    <div class="row" id="contenedor-servicios">
        {% for servicio in servicios %}
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm h-100">

                    <div class="card-body d-flex flex-column">
                        <!-- ============================= -->
                        <!-- INFO DEL PRESTADOR EN LA CARD -->
                        <!-- ============================= -->
                        <div class="prestador-info">

                            {% if servicio.usuario.imagen %}
                                <img
                                    src="{{ url_for('static', filename='uploads/' + servicio.usuario.imagen) }}"
                                    class="prestador-avatar"
                                >
                            {% else %}
                                <div class="prestador-avatar-placeholder">
                                    {{ servicio.usuario.nombre[0] }}
                                </div>
                            {% endif %}

                            <div>
                                <div class="prestador-nombre">
                                    {{ servicio.usuario.nombre }}
                                </div>
                                <div class="prestador-email">
                                    {{ servicio.usuario.email }}
                                </div>
                            </div>

                        </div>


                        <!-- Título -->
                        <h5 class="card-title">{{ servicio.titulo }}</h5>

                        <a href="{{ url_for('perfil_prestador', usuario_id=servicio.usuario_id) }}"
                        class="text-decoration-none text-info small">
                        Ver perfil del prestador
                        </a>

                        <!-- ⭐ PROMEDIO GENERAL PRESTADOR -->
                        <div class="mb-2">
                            {% if servicio.usuario.promedio_estrellas() %}
                                {{ render_estrellas(servicio.usuario.promedio_estrellas()) }}
                            {% else %}
                                <span class="text-muted small">Sin calificaciones</span>
                            {% endif %}
                        </div>

                        <!-- Descripción -->
                        <p class="card-text">
                            {{ servicio.descripcion }}
                        </p>

                        <!-- Categoría -->
                        <div class="mt-auto">
                            <span class="badge bg-primary">
                                {{ servicio.categoria }}
                            </span>
                        </div>

                        <!-- Botón Contratar (solo clientes) -->
                        {% if current_user.is_authenticated and current_user.rol == 'cliente' %}
                            <a href="{{ url_for('contratar_servicio', servicio_id=servicio.id) }}"
                            class="btn btn-primary btn-sm">
                            Contratar servicio
                            </a>
                        {% endif %}

                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12">
                <p class="text-muted text-center">
                    No hay servicios publicados aún.
                </p>
            </div>
        {% endfor %}
    </div>

</div>

<script>
/* =========================
   BUSCADOR EN VIVO AJAX
========================= */

const buscador = document.getElementById('buscador');
const contenedor = document.getElementById('contenedor-servicios');

let timeout = null;

buscador.addEventListener('input', function() {
    clearTimeout(timeout);

    timeout = setTimeout(async () => {
        const texto = buscador.value;

        const res = await fetch(`/api/buscar_servicios?q=${texto}`);
        const servicios = await res.json();

        contenedor.innerHTML = '';

        servicios.forEach(s => {
            contenedor.innerHTML += `
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h5 class="card-title">${s.titulo}</h5>
                        <p class="text-info mb-1">Prestador: ${s.prestador}</p>
                        <p>${s.descripcion}</p>
                        <span class="badge bg-primary">${s.categoria}</span>
                        <div class="mt-2 text-warning">
                            ⭐ ${s.promedio} / 5
                        </div>
                    </div>
                </div>
            </div>
            `;
        });

        if (servicios.length === 0) {
            contenedor.innerHTML = "<p class='text-muted'>No se encontraron servicios</p>";
        }

    }, 300); // espera 300ms mientras escribís (anti-lag)
});
</script>

{% endblock %}
